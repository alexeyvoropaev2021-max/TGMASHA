<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Telegram Shop</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, Arial; margin: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 10px 0; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #bbb; background: #fff; }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .muted { color:#666; font-size: 14px; }
  </style>
</head>
<body>
  <h2>üõç –ú–∞–≥–∞–∑–∏–Ω</h2>
  <div class="muted" id="who"></div>

  <div id="list"></div>

  <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
  <div id="cart" class="muted">–ü—É—Å—Ç–æ</div>
  <div class="row" style="margin-top:12px;">
    <div><b id="total">0 ‚ÇΩ</b></div>
    <button id="orderBtn">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand();
    const u = tg.initDataUnsafe?.user;
    document.getElementById("who").textContent =
      u ? `–í—ã: ${u.first_name} (id ${u.id})` : "–û—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram (–¥–ª—è —Ç–µ—Å—Ç–∞ –ø–æ–¥–ø–∏—Å—å –Ω–µ –ø—Ä–æ–π–¥—ë—Ç)";
  }

  const cart = new Map(); // productId -> qty
  let products = [];

  function renderCart() {
    const cartDiv = document.getElementById("cart");
    const totalDiv = document.getElementById("total");
    if (cart.size === 0) {
      cartDiv.textContent = "–ü—É—Å—Ç–æ";
      totalDiv.textContent = "0 ‚ÇΩ";
      return;
    }
    let total = 0;
    const lines = [];
    for (const [id, qty] of cart.entries()) {
      const p = products.find(x => x.id === id);
      const cost = p.price * qty;
      total += cost;
      lines.push(`${p.name} √ó ${qty} = ${cost} ‚ÇΩ`);
    }
    cartDiv.innerHTML = lines.map(x => `<div>${x}</div>`).join("");
    totalDiv.textContent = `${total} ‚ÇΩ`;
  }

  function renderProducts() {
    const list = document.getElementById("list");
    list.innerHTML = products.map(p => `
      <div class="card">
        <div class="row">
          <div>
            <div><b>${p.name}</b></div>
            <div class="muted">${p.price} ‚ÇΩ</div>
          </div>
          <div class="row">
            <button onclick="dec('${p.id}')">-</button>
            <div id="qty-${p.id}">0</div>
            <button onclick="inc('${p.id}')">+</button>
          </div>
        </div>
      </div>
    `).join("");
  }

  window.inc = (id) => {
    cart.set(id, (cart.get(id) || 0) + 1);
    document.getElementById(`qty-${id}`).textContent = cart.get(id);
    renderCart();
  }
  window.dec = (id) => {
    const q = (cart.get(id) || 0) - 1;
    if (q <= 0) cart.delete(id); else cart.set(id, q);
    document.getElementById(`qty-${id}`).textContent = cart.get(id) || 0;
    renderCart();
  }

  async function loadProducts() {
    const res = await fetch("/api/products");
    products = await res.json();
    renderProducts();
  }

  document.getElementById("orderBtn").addEventListener("click", async () => {
    if (!tg) { alert("–û—Ç–∫—Ä–æ–π –≤–Ω—É—Ç—Ä–∏ Telegram, –∏–Ω–∞—á–µ initData –Ω–µ–≤–∞–ª–∏–¥–µ–Ω."); return; }
    if (cart.size === 0) { alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞"); return; }

    const items = Array.from(cart.entries()).map(([id, qty]) => ({id, qty}));
    const body = { initData: tg.initData, items };

    const res = await fetch("/api/order", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (!res.ok) { alert("–û—à–∏–±–∫–∞: " + (data.detail || res.status)); return; }

    alert("–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –ò—Ç–æ–≥–æ: " + data.total + " ‚ÇΩ");
    cart.clear();
    products.forEach(p => document.getElementById(`qty-${p.id}`).textContent = 0);
    renderCart();
    tg.close(); // –ø–æ –∂–µ–ª–∞–Ω–∏—é
  });

  loadProducts();
</script>
</body>
</html>
